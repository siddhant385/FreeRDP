name: Setup RDP and LocalXpose on Windows VM

on: [push]

jobs:
  setup:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install LocalXpose using Chocolatey
      run: choco install localxpose -y

    - name: Print PATH Environment Variable
      run: echo $Env:PATH

    - name: List LocalXpose Files
      run: dir C:\ProgramData\chocolatey\bin

    - name: Add LocalXpose to PATH
      run: |
        $env:PATH += ";C:\ProgramData\chocolatey\bin"
        [System.Environment]::SetEnvironmentVariable('PATH', $env:PATH, [System.EnvironmentVariableTarget]::Machine)

    - name: Enable RDP
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
        
    - name: Ensure RDP User Exists
      run: |
        $username = "your-username"
        $password = "P@ssw0rd!2024"  # Use a complex password
        # Check if the user exists
        $user = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        if (-not $user) {
          # Create the user if it doesn't exist
          New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -FullName "RDP User" -Description "User for RDP access"
          Add-LocalGroupMember -Group "Administrators" -Member $username
        }
        else {
          # Update the password if the user already exists
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Set-LocalUser -Name $username -Password $securePassword
        }

    - name: Get help commands
      run: |
        loclx account login --auth ${{ secrets.LOCALXPOSE_API_KEY }}

    - name: Configure LocalXpose for Port Forwarding
      run: |
        # Confirm LocalXpose path and then configure
        loclx tcp --local-port 3389 --remote-port 3389 

    - name: Output RDP and LocalXpose Details
      run: |
        Write-Output "RDP is now enabled on the Windows VM. Use the following credentials:"
        Write-Output "Username: your-username"
        Write-Output "Password: P@ssw0rd!2024"
        Write-Output "LocalXpose is configured to forward port 3389. Use the following details:"
        Write-Output "API Key: ${{ secrets.LOCALXPOSE_API_KEY }}"
