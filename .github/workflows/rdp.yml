name: Setup RDP and LocalXpose on Windows VM

on: [push]

jobs:
  setup:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install LocalXpose using Chocolatey
      run: choco install localxpose -y

    - name: Enable RDP
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'
        
    - name: Ensure RDP User Exists
      run: |
        $username = "siddhant"
        $password = "Siddhant123"
        # Check if the user exists
        $user = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        if (-not $user) {
          # Create the user if it doesn't exist
          New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -FullName "RDP User" -Description "User for RDP access"
          Add-LocalGroupMember -Group "Administrators" -Member $username
        }
        else {
          # Update the password if the user already exists
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          Set-LocalUser -Name $username -Password $securePassword
        }

    - name: Configure LocalXpose for Port Forwarding
      run: |
        localxpose tcp --local-port 3389 --remote-port 3389 --auth ${{ secrets.LOCALXPOSE_API_KEY }}

    - name: Output RDP and LocalXpose Details
      run: |
        Write-Output "RDP is now enabled on the Windows VM. Use the following credentials:"
        Write-Output "Username: your-username"
        Write-Output "Password: your-password"
        Write-Output "LocalXpose is configured to forward port 3389. Use the following details:"
        Write-Output "API Key: ${{ secrets.LOCALXPOSE_API_KEY }}"
